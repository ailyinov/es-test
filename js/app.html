<!DOCTYPE html>
<html>
<head>
    <title></title>
    <style type="text/css">
        #gallery {
            list-style: none outside;
            overflow: auto;
            width: 100%
        }
        #gallery .photo-title {
            height: 40px;
            overflow: hidden;
            padding: 2px;
            font-size: 10px;
        }
        #progress-bar {
            background-color: #343434;
        }
        .percent-ready {
            width: 0;
            height: 20px;
            background-color: #78bb66;
        }
        /*.clear { clear: both; }*/
    </style>
    <script src="jquery-2.0.3.min.js"></script>
    <script>
        var Gallery = function() {
            var apiUrl = 'http://api.flickr.com/services/rest/';
            var apiResponseFormat = 'json';
            var apiKey = 'b7eb65d82d010950f8c2b1cea2961679';
            var apiMethod = {
                photos: {
                    getRecent: 'flickr.photos.getRecent',
                    getSizes: 'flickr.photos.getSizes'
                }
            };
            var flickrPhotosUrl = 'http://www.flickr.com/photos';
            var photos;
            var containerId = '#gallery';
            var progressBarId = '#progress-bar';

            var imagesPerRow = 10;

            $.getJSON(apiUrl + '?' + $.param({method: apiMethod.photos.getRecent, format: apiResponseFormat, api_key: apiKey}) + '&jsoncallback=?')
                    .done(function(data) {
                        photos = data.photos.photo;
                        onPhotosLoaded();
                    });

            function onPhotosLoaded() {
                var thumbnailsLoaded = 0;
                var progressStep = 100 / photos.length;
                var isAllThumbnailsLoaded = function () {
                    return photos.length == thumbnailsLoaded;
                };

                $.each(photos, function(key, photo) {
                    $.getJSON(apiUrl + '?' + $.param({method: apiMethod.photos.getSizes, format: apiResponseFormat, api_key: apiKey, photo_id: photo.id}) + '&jsoncallback=?')
                            .done(function(data) {
                                var thumbnail = $.grep(data.sizes.size, function(e) {return e.label == 'Thumbnail'});
                                if (thumbnail.length > 0) {
                                    thumbnail = thumbnail.pop();
                                    photo.thumbnail = {
                                        width: thumbnail.width,
                                        height: thumbnail.height,
                                        src: thumbnail.source
                                    };
                                }
                                photo.pageUrl = [flickrPhotosUrl, photo.owner, photo.id].join('/');
                                thumbnailsLoaded ++;
                                $(progressBarId).find('.percent-ready').width(progressStep * thumbnailsLoaded + '%');
                                if (isAllThumbnailsLoaded()) {
                                    $(progressBarId).hide();
                                    onThumbnailsLoaded();
                                }
                            });
                });
            }

            function onThumbnailsLoaded() {
                var images = $();
                var rows = $();
                $.each(photos, function(key, photo) {
                    var td = $('<td></td>').append(
                        $('<div></div>').width(photo.thumbnail.width).height(photo.thumbnail.height).append(
                            $('<img>').attr('src', photo.thumbnail.src)
                        ),
                        $('<div></div>').width(photo.thumbnail.width).addClass('photo-title').text(photo.title),
                        $('<a></a>').attr('href', photo.pageUrl).html('&raquo;')
                    );
                    images = images.add(td);
                    if (images.length == imagesPerRow) {
                        rows = rows.add($('<tr></tr>').append(images));
                        images = $();
                    }
                });
                rows = rows.add($('<tr></tr>').append(images));
                $(containerId).append(rows);
            }

        };

        $(function() {
            var gallery = new Gallery();
        });
    </script>
</head>
<body>
    <div id="progress-bar"><div class="percent-ready"></div></div>
    <table id="gallery"></table>
</body>
</html>